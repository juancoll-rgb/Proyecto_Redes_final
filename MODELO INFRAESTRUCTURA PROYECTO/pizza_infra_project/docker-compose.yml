
version: "3.9"

services:
  spark-master:
    image: apache/spark:3.5.1-python3
    container_name: spark-master
    hostname: spark-master
    environment:
      - SPARK_MODE=master
    command: ["/opt/spark/bin/spark-class", "org.apache.spark.deploy.master.Master"]
    ports:
      - "7077:7077"
      - "8080:8080"
    volumes:
      - ./data:/data
      - ./out:/data/out
      - ./spark:/app

  spark-worker-1:
    image: apache/spark:3.5.1-python3
    container_name: spark-worker-1
    hostname: spark-worker-1
    depends_on:
      - spark-master
    environment:
      - SPARK_MODE=worker
      - SPARK_MASTER_URL=spark://spark-master:7077
    command: ["/opt/spark/bin/spark-class", "org.apache.spark.deploy.worker.Worker", "spark://spark-master:7077"]
    volumes:
      - ./data:/data
      - ./out:/data/out

  spark-worker-2:
    image: apache/spark:3.5.1-python3
    container_name: spark-worker-2
    hostname: spark-worker-2
    depends_on:
      - spark-master
    environment:
      - SPARK_MODE=worker
      - SPARK_MASTER_URL=spark://spark-master:7077
    command: ["/opt/spark/bin/spark-class", "org.apache.spark.deploy.worker.Worker", "spark://spark-master:7077"]
    volumes:
      - ./data:/data
      - ./out:/data/out

  spark-submit:
    image: apache/spark:3.5.1-python3
    container_name: spark-submit
    depends_on:
      - spark-master
      - spark-worker-1
      - spark-worker-2
    volumes:
      - ./data:/data
      - ./out:/data/out
      - ./spark:/app
    entrypoint: ["/opt/spark/bin/spark-submit"]
    command:
      - "--master"
      - "spark://spark-master:7077"
      - "/app/pizza_sales_etl.py"


  api1:
    build: ./api
    container_name: api1
    environment:
      - OUT_DIR=/data/out
    volumes:
      - ./out:/data/out:ro
    expose:
      - "8000"
    depends_on:
      - spark-submit

  api2:
    build: ./api
    container_name: api2
    environment:
      - OUT_DIR=/data/out
    volumes:
      - ./out:/data/out:ro
    expose:
      - "8000"
    depends_on:
      - spark-submit

  nginx:
    image: nginx:alpine
    container_name: nginx-lb
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - api1
      - api2

  dashboard:
    build: ./dashboard
    container_name: dashboard
    ports:
      - "8501:8501"
    environment:
      - API_BASE=http://nginx
    depends_on:
      - nginx
